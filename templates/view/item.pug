extends ../layout.pug

block content
  h1.center #{item.title}
  p.center #{capitalize(item.item_type)} of 
    a( href=`${ADDR_PREFIX}/universes/${universe.shortname}` ) #{item.universe}
    if contextUser && (universe.author_permissions[contextUser.id] >= perms.WRITE/* || item.author === contextUser.username*/)
      |  - 
      a( href=`${ADDR_PREFIX}/universes/${universe.shortname}/items/${item.shortname}/edit` ) Edit
  p.center
    small Created by 
      a( href=`${ADDR_PREFIX}/users/${item.author}` ) #{item.author}
      |  #{formatDate(new Date(item.created_at))}
      |  - Last updated #{formatDate(new Date(item.updated_at))}
  hr

  if 'tabs' in item.obj_data
    .page
      each tabTuple in item.obj_data.tabs
        h3 #{tabTuple[0]}
        .itemTab
          each keyTuple in tabTuple[1]
            .itemKey
              span #{keyTuple[0]}
              hr
              span #{keyTuple[1]}

  if 'body' in item.obj_data
    .sheet
      +mdText(item.obj_data.body)
    script!= `window.ADDR_PREFIX = '${ADDR_PREFIX}'`
    script.
      window.onload = () => {
        const links = [...document.querySelectorAll('.intern-link')];

        for (const link of links) {
          fetch(`${ADDR_PREFIX}/api/universes/${link.dataset.universe}/items/${link.dataset.item}`).then((response) => {
            console.log(link.innerText, link.dataset.universe, link.dataset.item, response.status === 200)
            if (response.status === 200) {

            } else {
              link.classList.add('color-error')
            }
          });
        }
      };
